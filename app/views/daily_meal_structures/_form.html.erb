<%= form_with model: daily_meal_structure,
              class: "space-y-6",
              data: {
                controller: "meal-structure-form"
              } do |form| %>
  <% if daily_meal_structure.errors.any? %>
    <div class="rounded-lg bg-red-50 p-4 border border-red-200">
      <h3 class="text-sm font-medium text-red-800 mb-2">
        <%= pluralize(daily_meal_structure.errors.count, "error") %> prevented this meal structure from being saved:
      </h3>
      <ul class="list-disc list-inside text-sm text-red-700">
        <% daily_meal_structure.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= form.label :name, "Meal Structure Name", class: "block text-sm font-medium text-gray-700 mb-1" %>
    <%= form.text_field :name,
                       required: true,
                       placeholder: "e.g., Three Meals a Day, OMAD, Breakfast and Dinner",
                       class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm px-3 py-2 border" %>
  </div>

  <div>
    <h3 class="text-lg font-medium text-gray-900 mb-4">Meals</h3>

    <div data-meal-structure-form-target="mealsContainer" class="space-y-6">
      <%= form.fields_for :meal_structure_items do |item_form| %>
        <%= render "meal_structure_item_fields", form: item_form, food_categories: FoodCategory.order(:description) %>
      <% end %>
    </div>

    <button type="button"
            data-action="click->meal-structure-form#addMeal"
            class="mt-4 inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
      <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
      Add Another Meal
    </button>
  </div>

  <div class="flex items-center gap-3 pt-4">
    <%= form.submit class: "rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 cursor-pointer" %>
    <%= link_to "Cancel",
                daily_meal_structures_path,
                class: "rounded-md bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 border border-gray-300" %>
  </div>

  <%# Template for new meal items (hidden, cloned by Stimulus) %>
  <template data-meal-structure-form-target="mealTemplate">
    <%= form.fields_for :meal_structure_items, MealStructureItem.new, child_index: "NEW_RECORD" do |item_form| %>
      <%= render "meal_structure_item_fields", form: item_form, food_categories: FoodCategory.order(:description) %>
    <% end %>
  </template>
<% end %>
